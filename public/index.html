<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>dubix speech to text site</title>
<style>
body { font-family:sans-serif; max-width:600px; margin:1rem auto; text-align:center }
button { padding:10px 15px; margin:5px; }
#log { text-align:left; white-space:pre-wrap; background:#111; color:#0f0; padding:1em; height:200px; overflow:auto; }
</style>
</head>
<body>
<h2>speech to text by dubix</h2>
<button id="startBtn">ðŸŽ™ Start Stream</button>
<button id="stopBtn">ðŸ›‘ Stop Stream</button>
<div id="log"></div>

<script>
let mediaRecorder;
let interval;
const logEl = document.getElementById("log");

function log(t){ logEl.textContent += t + "\n"; logEl.scrollTop = logEl.scrollHeight; }

document.getElementById("startBtn").onclick = async () => {
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  const ctx = new AudioContext({ sampleRate: 16000 });
  const src = ctx.createMediaStreamSource(stream);

  // âœ… Changed buffer size from 4096 to 512
  const processor = ctx.createScriptProcessor(4096, 1, 1);

  src.connect(processor);
  processor.connect(ctx.destination);
  log("ðŸŽ¤ Started capturing...");

  processor.onaudioprocess = e => {
    const input = e.inputBuffer.getChannelData(0);
    const pcm16 = new Int16Array(input.length);
    for (let i = 0; i < input.length; i++) pcm16[i] = input[i] * 0x7fff;
    fetch("/stream", { method: "POST", body: pcm16.buffer });
  };

  interval = setInterval(async () => {
    const res = await fetch("/poll");
    const json = await res.json();
    if (json.length > 0) {
      log("ðŸ” WS Response: " + JSON.stringify(json, null, 2));
    }
  }, 150);

  document.getElementById("stopBtn").onclick = () => {
    clearInterval(interval);
    processor.disconnect();
    src.disconnect();
    ctx.close();
    log("ðŸ›‘ Stopped.");
  };
};
</script>
</body>
</html>